#!/usr/bin/env node
var DateFns = require("date-fns")
var budgetsDb = require("root/db/budgets_db")
var ideasDb = require("root/db/ideas_db")
var votesDb = require("root/db/votes_db")
var co = require("co")
var sql = require("sqlate")
var {sqlite} = require("root")
var {logger} = require("root")
module.exports = anonymize

function* anonymize() {
	var expiringBudgets = yield budgetsDb.search(sql`
		SELECT school.name AS school_name, budget.* FROM budgets AS budget
		JOIN schools AS school ON school.id = budget.school_id
		WHERE budget.voting_ends_at <= ${DateFns.addDays(new Date, -7)}
		AND budget.expired_at IS NULL
	`)

	yield expiringBudgets.map(function*(budget) {
		logger.info(
			"Expiring %s's budget \"%s\" (%d)…",
			budget.school_name,
			budget.title,
			budget.id
		)

		yield budgetsDb.update(budget, {expired_at: new Date})
	})

	var expiredBudgets = yield budgetsDb.search(sql`
		SELECT school.name AS school_name, budget.* FROM budgets AS budget
		JOIN schools AS school ON school.id = budget.school_id
		WHERE budget.expired_at <= ${DateFns.addDays(new Date, -7)}
		AND budget.anonymized_at IS NULL
	`)

	for (var i = 0; i < expiredBudgets.length; ++i) {
		let budget = expiredBudgets[i]

		logger.info(
			"Anonymizing %s's budget \"%s\" (%d)…",
			budget.school_name,
			budget.title,
			budget.id
		)

		yield sqlite.transactAsync(function*() {
			yield budgetsDb.update(budget, {anonymized_at: new Date})

			var ideas = yield ideasDb.search(sql`
				SELECT * FROM ideas WHERE budget_id = ${budget.id}
			`)

			var votesByIdea = yield votesDb.countVotesByIdea(budget.id)

			yield ideas.map(function*(idea) {
				yield ideasDb.update(idea, {vote_count: votesByIdea[idea.id] || 0})
			})

			yield sqlite(sql`DELETE FROM voters WHERE budget_id = ${budget.id}`)

			yield sqlite(sql`DELETE FROM votes WHERE budget_id = ${budget.id}`)

			yield sqlite(sql`DELETE FROM paper_votes WHERE budget_id = ${budget.id}`)
		})
	}
}

if (module.parent) return

Promise.resolve(co(anonymize)).catch(function(err) {
	console.error(err)
	process.exitCode = 1
})
